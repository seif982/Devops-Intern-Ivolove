pipeline {
    agent { label 'docker-agent' }

    environment {
        DOCKER_IMAGE = "seif982/jenkins-app"
        BUILD_TAG    = "${env.BUILD_NUMBER}"
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ Credentials ÙÙŠ Ø¬Ù†ÙƒÙŠÙ†Ø² ØªØ­Øª ID Ø¨Ø§Ø³Ù… docker-creds
        DOCKER_CREDS = credentials('docker-creds') 
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Build & Push Image') {
            steps {
                script {
                    // Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡ Ù‡ÙŠØ®Ù„ÙŠÙ†Ø§ Ù†ØªØ£ÙƒØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠÙ† Ø¨Ø§Ù„Ø¸Ø¨Ø·
                    sh "ls -R" 
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù€ Dockerfile ÙÙŠ Ø§Ù„ÙÙˆÙ„Ø¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù… '.' Ù…Ø¨Ø§Ø´Ø±Ø©
                    // Ù„Ùˆ ÙÙŠ ÙÙˆÙ„Ø¯Ø± ÙØ±Ø¹ÙŠØŒ ØºÙŠØ± '.' Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙÙˆÙ„Ø¯Ø±
                    sh "docker build -t ${DOCKER_IMAGE}:${BUILD_TAG} ."
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù€ DockerHub ÙˆØ¹Ù…Ù„ Push
                    sh "echo ${DOCKER_CREDS_PSW} | docker login -u ${DOCKER_CREDS_USR} --password-stdin"
                    sh "docker push ${DOCKER_IMAGE}:${BUILD_TAG}"
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "ğŸš€ Deploying to K8s..."
                    // Ù‡Ù†Ø§ Ø¶ÙŠÙ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù€ kubectl Ø¨ØªØ§Ø¹ØªÙƒ
                    // sh "kubectl set image deployment/my-app my-app=${DOCKER_IMAGE}:${BUILD_TAG}"
                }
            }
        }
    }

    post {
        always {
            sh "docker logout"
            echo "Done!"
        }
        success {
            echo "âœ… Build and Push Successful!"
        }
        failure {
            echo "âŒ Build Failed, check the logs above."
        }
    }
}
